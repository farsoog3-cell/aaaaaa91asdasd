<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Molfa Embroidery â€” ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØºØ±Ø²</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f3f4f6; color:#111;}
  .mono{font-family:ui-monospace, Menlo, Monaco, "Roboto Mono", monospace;}
  .svg-wrap { width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
  .svg-wrap svg, .svg-wrap object { width:100%; height:100%; }
</style>
</head>
<body class="min-h-screen flex flex-col">
<header class="bg-indigo-700 text-white py-4 shadow text-center">
  <h1 class="text-xl md:text-2xl font-semibold">Molfa Embroidery â€” ØªØ­ÙˆÙŠÙ„ Ø£ÙŠ ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØºØ±Ø²</h1>
</header>

<main class="container mx-auto p-4 md:p-6 flex-grow">
  <div class="bg-white rounded-xl shadow p-4 md:p-6 space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="space-y-3">
        <label class="block font-medium">Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
        <input id="file" type="file" accept="image/*" class="w-full p-2 border rounded"/>
        <div class="mt-3 flex flex-col sm:flex-row gap-3">
          <button id="process" class="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">ğŸ”§ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØºØ±Ø² ÙˆÙ…Ù„ÙØ§Øª</button>
        </div>
        <div class="mt-3 flex flex-col sm:flex-row gap-3">
          <button id="downloadSvg" class="flex-1 bg-blue-600 text-white py-2 rounded hidden">â¬‡ï¸ SVG</button>
          <button id="downloadDst" class="flex-1 bg-green-600 text-white py-2 rounded hidden">â¬‡ï¸ DST</button>
          <button id="downloadDte" class="flex-1 bg-pink-600 text-white py-2 rounded hidden">â¬‡ï¸ DTE</button>
          <button id="downloadPng" class="flex-1 bg-gray-700 text-white py-2 rounded hidden">â¬‡ï¸ PNG</button>
        </div>
      </div>
      <div class="md:col-span-2 space-y-3">
        <div class="bg-gray-50 p-3 rounded min-h-[300px] flex items-center justify-center">
          <div id="svgPreview" class="svg-wrap w-full h-full text-gray-500">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø¹Ø¯</div>
        </div>
        <pre id="log" class="mono text-xs h-40 overflow-auto whitespace-pre-wrap bg-white p-2 rounded border"></pre>
      </div>
    </div>
  </div>
</main>

<script>
function log(msg){ document.getElementById('log').textContent += msg + "\n"; }
function forceDownload(blob, name){ const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),2000); }

function makeWorkerFromFunc(fn){ const src = fn.toString(); const blob=new Blob(['('+src+')()'],{type:'application/javascript'}); return new Worker(URL.createObjectURL(blob)); }

const worker = makeWorkerFromFunc(function(){
  onmessage = async (ev)=>{
    const {dataURL} = ev.data;
    try{
      const img = await createImageBitmap(await (await fetch(dataURL)).blob());
      const w = 500, h = Math.round(img.height*(500/img.width));
      const off = new OffscreenCanvas(w,h);
      const ctx=off.getContext('2d');
      ctx.drawImage(img,0,0,w,h);
      const id=ctx.getImageData(0,0,w,h);

      // ØªØ­ÙˆÙŠÙ„ Ù…Ø¨Ø³Ø· Ù„Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø£Ø¨ÙŠØ¶/Ø£Ø³ÙˆØ¯ + Ù†Ù‚Ø§Ø· ØºØ±Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙˆØ§Ù
      const stitches=[];
      for(let y=0;y<h;y+=4){
        for(let x=0;x<w;x+=4){
          const i=(y*w+x)*4;
          const gray=(id.data[i]+id.data[i+1]+id.data[i+2])/3;
          if(gray<128){ // Ø¬Ø²Ø¡ ØºØ§Ù…Ù‚ => ØºØ±Ø²Ø©
            stitches.push([x,y,false]);
          }
        }
      }
      if(stitches.length<2) stitches.push([0,0,false],[20,20,false]);

      // build DST/DTE arrays
      function toCoord(px){ return Math.round(px*0.2); } // px -> 0.1mm
      function buildDst(points,label){
        const header=new Uint8Array(512);
        const name=('LA:'+label+'\n').slice(0,80);
        for(let i=0;i<name.length;i++) header[i]=name.charCodeAt(i);
        const body=[]; let prevx=0,prevy=0;
        for(const [xx,yy] of points){
          const x=toCoord(xx), y=toCoord(yy);
          let dx=x-prevx, dy=y-prevy;
          while(Math.abs(dx)>127||Math.abs(dy)>127){
            const sx=Math.max(-127,Math.min(127,dx));
            const sy=Math.max(-127,Math.min(127,dy));
            body.push(sx&0xFF,sy&0xFF,0x03); dx-=sx; dy-=sy; prevx+=sx; prevy+=sy;
          }
          body.push(dx&0xFF,dy&0xFF,0x03); prevx=x; prevy=y;
        }
        body.push(0x00,0x00,0xF3);
        const arr=new Uint8Array(512+body.length); arr.set(header,0); arr.set(new Uint8Array(body),512); return arr;
      }
      const dstArr=buildDst(stitches,'MOLFA_DST');
      const dteArr=buildDst(stitches,'MOLFA_DTE');

      // SVG: Ø§Ù„ØµÙˆØ±Ø© + Ø§Ù„ØºØ±Ø² + start/end
      let svg=`<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'>`;
      const url = dataURL;
      svg+=`<image href='${url}' x='0' y='0' width='${w}' height='${h}'/>`;
      svg+=`<polyline points='${stitches.map(p=>p[0]+','+p[1]).join(' ')}' fill='none' stroke='red' stroke-width='1'/>`;
      svg+=`<circle cx='${stitches[0][0]}' cy='${stitches[0][1]}' r='3' fill='green'/>`;
      svg+=`<circle cx='${stitches[stitches.length-1][0]}' cy='${stitches[stitches.length-1][1]}' r='3' fill='blue'/>`;
      svg+=`</svg>`;

      const pngBlob=await off.convertToBlob({type:'image/png'});
      postMessage({svg,dst:dstArr.buffer,dte:dteArr.buffer,png:pngBlob},[dstArr.buffer,dteArr.buffer]);
    }catch(e){ postMessage({error:e.message}); }
  }
});

const fileInput=document.getElementById('file');
const btn=document.getElementById('process');
const svgPreview=document.getElementById('svgPreview');
const dlSvg=document.getElementById('downloadSvg');
const dlDst=document.getElementById('downloadDst');
const dlDte=document.getElementById('downloadDte');
const dlPng=document.getElementById('downloadPng');

let lastSvg,lastDst,lastDte,lastPng;

worker.onmessage=(ev)=>{
  if(ev.data.error){ log('Ø®Ø·Ø£: '+ev.data.error); return; }
  lastSvg=new Blob([ev.data.svg],{type:'image/svg+xml'});
  lastDst=new Blob([ev.data.dst],{type:'application/octet-stream'});
  lastDte=new Blob([ev.data.dte],{type:'application/octet-stream'});
  lastPng=ev.data.png;
  const url=URL.createObjectURL(lastSvg);
  svgPreview.innerHTML=`<object type="image/svg+xml" data="${url}" style="width:100%;height:100%"></object>`;
  dlSvg.classList.remove('hidden'); dlDst.classList.remove('hidden'); dlDte.classList.remove('hidden'); dlPng.classList.remove('hidden');
  dlSvg.onclick=()=>forceDownload(lastSvg,'pattern.svg');
  dlDst.onclick=()=>forceDownload(lastDst,'pattern.dst');
  dlDte.onclick=()=>forceDownload(lastDte,'pattern.dte');
  dlPng.onclick=()=>forceDownload(lastPng,'preview.png');
  log('âœ” ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø®Ø·Ø· Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø®Ù„ÙÙŠØ©');
}

btn.onclick=async()=>{
  const f=fileInput.files[0];
  if(!f){ alert('Ø§Ø®ØªØ± ØµÙˆØ±Ø©'); return; }
  const fr=new FileReader();
  fr.onload=()=>{ worker.postMessage({dataURL:fr.result}); };
  fr.readAsDataURL(f);
}
</script>
</body>
</html>
