<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Molfa โ ูุญูู ุงูุตูุฑ ุฅูู ุชุทุฑูุฒ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ููุณุงุช ุตุบูุฑุฉ */
    .glass {
      background: linear-gradient(135deg, rgba(255,255,255,0.65), rgba(255,255,255,0.35));
      backdrop-filter: blur(6px);
    }
    .btn-glow {
      box-shadow: 0 6px 18px rgba(99,102,241,0.18);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center p-6">
  <main class="w-full max-w-4xl">
    <div class="glass rounded-3xl shadow-2xl p-8">
      <header class="flex items-center justify-between gap-4 mb-6">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 bg-gradient-to-tr from-indigo-600 to-violet-500 text-white rounded-xl flex items-center justify-center text-2xl font-bold">M</div>
          <div>
            <h1 class="text-2xl font-extrabold">Molfa โ ูุญููู ุงูุตูุฑ ุฅูู ุชุทุฑูุฒ</h1>
            <p class="text-sm text-slate-600">ุงุฑูุน ุตูุฑุฉุ ุงุฎุชุฑ ููุน ุงููููุ ูุซู ุงููุฑ "ุงุจุฏุฃ ุงูุชุทุฑูุฒ" ูุชุญุตู ุนูู ููู ุฌุงูุฒ ูููุงูููุฉ.</p>
          </div>
        </div>

        <div class="text-sm text-slate-500">
          ุงูุฅุตุฏุงุฑ ุงูุชุฌุฑูุจู โข Ubuntu server + Ink/Stitch ูุชูุงูู
        </div>
      </header>

      <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- ุงููุณุงุฑ: ุฃุฏูุงุช ุงูุฑูุน ูุงูุฅุนุฏุงุฏ -->
        <div class="space-y-4">
          <label class="block">
            <span class="text-sm font-medium text-slate-700">ุงูุตูุฑุฉ</span>
            <input id="fileInput" type="file" accept="image/*" class="mt-2 w-full text-sm" />
          </label>

          <div class="flex items-center gap-2 mt-2">
            <button id="btnPick" class="btn-glow inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow">
              ๐ค ุฑูุน ุตูุฑุฉ
            </button>
            <button id="btnReset" class="inline-flex items-center gap-2 bg-white border px-4 py-2 rounded-lg hover:bg-slate-50">ุฅุนุงุฏุฉ ุชุนููู</button>
          </div>

          <div class="mt-4">
            <span class="text-sm font-medium text-slate-700">ุฅุนุฏุงุฏ/ููุท</span>
            <div class="mt-2 flex gap-2">
              <button class="preset px-3 py-2 rounded-lg border" data-preset="logo">ุดุนุงุฑ</button>
              <button class="preset px-3 py-2 rounded-lg border" data-preset="photo">ุตูุฑุฉ ููุชูุบุฑุงููุฉ</button>
              <button class="preset px-3 py-2 rounded-lg border" data-preset="line">ุฎุทู</button>
            </div>
          </div>

          <div class="mt-4">
            <span class="text-sm font-medium text-slate-700">ููุน ููู ุงููุงูููุฉ</span>
            <div class="mt-2 flex gap-2">
              <label class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border cursor-pointer">
                <input type="radio" name="format" value="DST" checked /> <span class="text-sm">DST</span>
              </label>
              <label class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border cursor-pointer">
                <input type="radio" name="format" value="PES" /> <span class="text-sm">PES</span>
              </label>
              <label class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border cursor-pointer">
                <input type="radio" name="format" value="DSE" /> <span class="text-sm">DSE</span>
              </label>
            </div>
          </div>

          <div class="mt-6 flex gap-3">
            <button id="startBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-2xl font-semibold">๐งต ุงุจุฏุฃ ุงูุชุทุฑูุฒ</button>
            <button id="previewBtn" class="w-44 bg-slate-100 border hover:bg-slate-200 rounded-2xl text-slate-700 py-3">๐ ุนุฑุถ ูุนุงููุฉ</button>
          </div>

          <div id="statusBox" class="mt-4 p-3 rounded-lg bg-white border text-sm text-slate-600 hidden"></div>

          <div class="mt-3 text-xs text-slate-500">
            ููุงุญุธุฉ: ูุฐู ุงููุงุฌูุฉ ุชุชููุน ูุฌูุฏ API ูู /api/digitize ุงูุฐู ูุนุงูุฌ ุงูุตูุฑุฉ ููุนูุฏ ุจููู ุงูุชุทุฑูุฒ. ุฅู ูู ููู ุงูุฎุงุฏู ุฌุงูุฒูุง ุณูุชู ุงุณุชุฎุฏุงู ูุญุงูุงุฉ ูุญููุฉ.
          </div>
        </div>

        <!-- ุงููููู: ูุนุงููุงุช ููุชูุฌุฉ -->
        <div class="space-y-4">
          <div class="bg-white border rounded-xl p-4 min-h-[260px] flex flex-col items-center justify-center">
            <div id="previewContainer" class="w-full flex flex-col items-center gap-3">
              <div class="text-xs text-slate-500">ูุนุงููุฉ ุงูุตูุฑุฉ ุงููุฑููุนุฉ</div>
              <img id="previewImg" src="" alt="preview" class="max-h-56 rounded-lg shadow hidden" />
              <div id="noPreview" class="text-slate-400">ูู ุชูู ุจุฑูุน ุฃู ุตูุฑุฉ ุจุนุฏ</div>
            </div>
          </div>

          <div class="bg-white border rounded-xl p-4">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold text-slate-700">ุงููุฎุฑุฌุงุช</h3>
              <div id="fileNameBadge" class="text-xs text-slate-500">ูุง ููู ุญุชู ุงูุขู</div>
            </div>

            <div id="resultArea" class="mt-3 hidden">
              <div class="flex items-center gap-3">
                <img id="stitchedPreview" src="" alt="Stitched preview" class="w-24 h-24 rounded-lg border shadow object-cover" />
                <div class="flex-1">
                  <div id="resultMsg" class="text-sm font-medium text-slate-700">ุงูุชุตููู ุฌุงูุฒ</div>
                  <div id="resultSub" class="text-xs text-slate-500 mt-1">ููููู ุชูุฒูู ุงูููู ุฃู ุฅุฑุณุงูู ูููุงูููุฉ</div>
                </div>
              </div>

              <div class="mt-4 flex gap-3">
                <a id="downloadLink" class="flex-1 inline-flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg" download>
                  โฌ๏ธ ุชูุฒูู ุงูููู
                </a>
                <button id="sendToMachine" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">โ๏ธ ููููููุฉ</button>
              </div>
            </div>

            <div id="resultEmpty" class="mt-3 text-sm text-slate-500">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุจุนุฏ ุงูุชุญููู</div>
          </div>

        </div>
      </section>

      <footer class="mt-6 text-xs text-slate-500 text-center">
        ยฉ Molfa โ ุชุฌุฑุจุฉ ุชุฌุฑูุจูุฉ. ุชุฃูุฏ ูู ุงุฎุชุจุงุฑ ุงูุฎูุงุทุฉ ุนูู ููุงุด ุชุฌุฑูุจู ูุจู ุงูุชุดุบูู ุงูุฅูุชุงุฌู.
      </footer>
    </div>
  </main>

  <script>
    // ุนูุงุตุฑ DOM
    const fileInput = document.getElementById('fileInput');
    const btnPick = document.getElementById('btnPick');
    const btnReset = document.getElementById('btnReset');
    const previewImg = document.getElementById('previewImg');
    const noPreview = document.getElementById('noPreview');
    const previewContainer = document.getElementById('previewContainer');
    const startBtn = document.getElementById('startBtn');
    const previewBtn = document.getElementById('previewBtn');
    const statusBox = document.getElementById('statusBox');
    const resultArea = document.getElementById('resultArea');
    const resultEmpty = document.getElementById('resultEmpty');
    const stitchedPreview = document.getElementById('stitchedPreview');
    const fileNameBadge = document.getElementById('fileNameBadge');
    const downloadLink = document.getElementById('downloadLink');
    const sendToMachine = document.getElementById('sendToMachine');

    let currentFile = null;
    let currentPreset = 'logo';

    // ุฒุฑูุชุญ ูุงูุฐุฉ ุงููููุงุช
    btnPick.addEventListener('click', () => fileInput.click());

    // ุงุฎุชูุงุฑ ููู
    fileInput.addEventListener('change', e => {
      const f = e.target.files[0];
      if (!f) return;
      currentFile = f;
      const url = URL.createObjectURL(f);
      previewImg.src = url;
      previewImg.classList.remove('hidden');
      noPreview.classList.add('hidden');
      fileNameBadge.textContent = f.name;
      // ุฅุฎูุงุก ุงููุชุงุฆุฌ ุงููุฏููุฉ
      resultArea.classList.add('hidden');
      resultEmpty.classList.remove('hidden');
      downloadLink.removeAttribute('href');
      downloadLink.removeAttribute('download');
      stitchedPreview.src = '';
    });

    // ุฅุนุงุฏุฉ ุชุนููู
    btnReset.addEventListener('click', () => {
      fileInput.value = '';
      currentFile = null;
      previewImg.src = '';
      previewImg.classList.add('hidden');
      noPreview.classList.remove('hidden');
      fileNameBadge.textContent = 'ูุง ููู ุญุชู ุงูุขู';
      resultArea.classList.add('hidden');
      resultEmpty.classList.remove('hidden');
      statusBox.classList.add('hidden');
    });

    // ุงุฎุชูุงุฑุงุช ุงูู preset
    document.querySelectorAll('.preset').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.preset').forEach(x => x.classList.remove('bg-indigo-50', 'border-indigo-600'));
        btn.classList.add('bg-indigo-50', 'border-indigo-600');
        currentPreset = btn.dataset.preset;
      });
    });
    // ุชูุนูู ุงูุงูุชุฑุงุถู
    document.querySelector('.preset[data-preset="logo"]').classList.add('bg-indigo-50', 'border-indigo-600');

    // ูุนุงููุฉ ุณุฑูุนุฉ (ููุท ูุนุฑุถ ุงูุตูุฑุฉ)
    previewBtn.addEventListener('click', () => {
      if (!currentFile) return alert('ุงุฎุชุฑ ุตูุฑุฉ ุฃููุงู');
      window.open(previewImg.src, '_blank');
    });

    // ูุณุงุนุฏุฉ: ุงุญุตู ุนูู ููุน ุงูููู ุงููุญุฏุฏ
    function getSelectedFormat() {
      const r = document.querySelector('input[name="format"]:checked');
      return r ? r.value : 'DST';
    }

    // ุงุจุฏุฃ ุงูุชุทุฑูุฒ: ุงุณุชุฏุนุงุก API ุฃู ูุญุงูุงุฉ
    startBtn.addEventListener('click', async () => {
      if (!currentFile) return alert('ุงุฎุชุฑ ุตูุฑุฉ ุฃููุงู');
      const format = getSelectedFormat();

      // ุนุฑุถ ุญุงูุฉ
      statusBox.classList.remove('hidden');
      statusBox.textContent = 'ุฌุงุฑู ุฑูุน ุงูุตูุฑุฉ ูุฅุนุฏุงุฏูุง...';

      // ุจูุงุก ุงูููุฑู ุฏุงุชุง
      const fd = new FormData();
      fd.append('image', currentFile);
      fd.append('preset', currentPreset);
      fd.append('format', format);

      // ูุญุงููุฉ ุฅุฑุณุงู ููู API (ูุณุงุฑ ุงูุชุฑุงุถู /api/digitize)
      const apiUrl = '/api/digitize';

      try {
        // ูุณุชุฎุฏู fetch ููุธูุฑ ุดุฑูุท ุจุณูุท ููุชูุฏู (ูุงุณุชุฌุงุจุฉ ุงูุจุฑุงูุฒุฑ)
        const res = await fetch(apiUrl, {
          method: 'POST',
          body: fd
        });

        if (!res.ok) throw new Error('ูุดู ุงูุฎุงุฏู: ' + res.status);

        // ูุญุงูู ุงูุญุตูู ุนูู ุงุณู ุงูููู ูู ุงูููุฏุฑ
        const filename = res.headers.get('x-filename') || (currentFile.name.split('.').slice(0, -1).join('.') + '.' + format.toLowerCase());

        // ูุญุตู ุนูู blob
        const blob = await res.blob();

        // ุฅู ุงูุฎุงุฏู ูุนูุฏ ูุนุงููุฉ ุตูุฑุฉ (png/jpg) ูููุตู ุนููุง โ ููู ููุง ููุชุฑุถ ุฃูู ูุนูุฏ ุจุงูููู ุงูููุงุฆู (ูุซู .dst) ูุฃุญูุงูุงู ููููุฑ ูุนุงููุฉ ูู ููุฏุฑ ุขุฎุฑ
        // ูุนุทู ุงูุฑุงุจุท ููุชูุฒูู:
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.download = filename;
        downloadLink.textContent = 'โฌ๏ธ ุชูุฒูู ' + filename;

        // ุฅู ูุงู ุงูุฎุงุฏู ุฃูุถุงู ูุฑุณู ูุนุงููุฉ ูุทุฑุฒุฉ (ูุซูุงู ูู header x-preview: image/png as base64 ุฃู ููู ููุญู) โ ูุฐุง ูุชุทูุจ ุชูุณูู ุฅุถุงูู ูู ุงูุฎุงุฏู.
        // ููุง ุณูุนุฑุถ ุตูุฑุฉ "ูุตุบูุฑุฉ" ูุญุงูุงุฉ: ูุทูุจ ูู ุงูุฎุงุฏู ููู ูุนุงููุฉ ุฅุฐุง ุฃุนุงุฏ ููุน image/*
        if (blob.type.startsWith('image/')) {
          // ุงูุฎุงุฏู ุฃุฑุณู ุตูุฑุฉ ูุนุงููุฉ
          stitchedPreview.src = url;
        } else {
          // ุงูุฎุงุฏู ุฃุฑุณู ููู ุชุทุฑูุฒ (binary) โ ูุง ูููู ุนุฑุถู ูุตูุฑุฉุ ูุนุฑุถ ุตูุฑุฉ ูุญุงููุฉ ูู ุงูู preview ุงูุฃุตูู ูุน ุชุฃุซูุฑ
          stitchedPreview.src = previewImg.src;
        }

        // ุฅุธูุงุฑ ููุทูุฉ ุงููุชุงุฆุฌ
        resultArea.classList.remove('hidden');
        resultEmpty.classList.add('hidden');
        statusBox.textContent = 'ุชู ุชุญููู ุงูููู ุจูุฌุงุญ!';
        fileNameBadge.textContent = filename;

      } catch (err) {
        console.error(err);
        // ูุญุงูุงุฉ ูุญููุฉ ุฅุฐุง ูุงู ุงูุฎุงุฏู ุบูุฑ ููุฌูุฏ ุฃู ูุดู
        statusBox.textContent = 'ุชุนุฐูุฑ ุงููุตูู ุฅูู ุงูุฎุงุฏูุ ุณูุชู ุงุณุชุฎุฏุงู ุงููุญุงูุงุฉ ุงููุญููุฉ...';
        await simulateLocalConversion(getSelectedFormat());
      }
    });

    // ุฒุฑ ุฅุฑุณุงู ููููููุฉ (ูููู ุฑุจุทู ุจููุทุฉ API ุฃุฎุฑู)
    sendToMachine.addEventListener('click', () => {
      const dl = downloadLink.href;
      if (!dl) return alert('ูุง ููุฌุฏ ููู ูุชูุฒููู ุจุนุฏ');
      // ููุง ูููู ุฅุถุงูุฉ ููุทู ุฅุฑุณุงู ุงูููู ูุจุงุดุฑุฉ ุฅูู ุณูุฑูุฑ ุงููุงูููุฉ ุฃู ุฅุถุงูุฉ ูุงุฌูุฉ ุทุจุงุนุฉ
      alert('ุชู ุชุฌููุฒ ุงูููู ูููุงูููุฉ. ููููู ุชูุฒููู ุงูุขู ุฃู ุฑูุนู ูุจุฑูุงูุฌ ุงููุงูููุฉ.');
      window.location = dl; // ุชูุฒูู ููุฑู
    });

    // --- ูุญุงูุงุฉ ูุญููุฉ ููููุญูููููููุฉ ุฅุฐุง ูู ููุฌุฏ ุฎุงุฏู ---
    async function simulateLocalConversion(format) {
      statusBox.textContent = 'ุฌุงุฑู ุชุญููู ุงูุตูุฑุฉ ูุญููุงู (ูุญุงูุงุฉ)...';
      // ุชุฃุฎูุฑ ุจุณูุท ููุญุงูุงุฉ ุงูุฒูู ุงูุญูููู
      await new Promise(r => setTimeout(r, 1500));
      const fakeContent = 'PROTOTYPE-EMBROIDERY-DATA';
      const blob = new Blob([fakeContent], { type: 'application/octet-stream' });
      const filename = (currentFile ? currentFile.name.split('.').slice(0, -1).join('.') : 'design') + '.' + format.toLowerCase();
      const url = URL.createObjectURL(blob);
      downloadLink.href = url;
      downloadLink.download = filename;
      downloadLink.textContent = 'โฌ๏ธ ุชูุฒูู ' + filename;

      stitchedPreview.src = previewImg.src;
      resultArea.classList.remove('hidden');
      resultEmpty.classList.add('hidden');
      fileNameBadge.textContent = filename;
      statusBox.textContent = 'ุชู ุงูุชุญููู (ูุญุงูุงุฉ). ูู ุจุชูุฒูู ุงูููู ูุฌุฑุจู ุนูู ูุงูููุฉ ุงูุงุฎุชุจุงุฑ.';
    }

  </script>
</body>
</html>
