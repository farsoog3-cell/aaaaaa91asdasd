<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Molfa â€” ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØºØ±Ø²Ø© (DST Ù…Ù„ÙˆÙ†)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{font-family:system-ui,Arial;background:#111;color:#eee;}
  header{background:#000;color:#fff;}
  .mono{font-family:ui-monospace,monospace;}
  canvas{max-width:100%;height:auto;border:1px solid #444;}
</style>
</head>
<body class="min-h-screen flex flex-col">
<header class="py-4 text-center shadow">
  <h1 class="text-xl font-bold">ğŸ§µ Molfa â€” ØµÙˆØ±Ø© â†’ ØªØ·Ø±ÙŠØ² (DST Ù…Ù„ÙˆÙ†)</h1>
  <p class="text-sm opacity-80">Ø¥Ø¶Ø§ÙØ© ØªØºÙŠÙŠØ±Ø§Øª Ø£Ù„ÙˆØ§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¯Ø§Ø®Ù„ Ù…Ù„Ù Ø§Ù„ØªØ·Ø±ÙŠØ².</p>
</header>

<main class="container mx-auto p-4 flex-grow">
  <div class="grid md:grid-cols-3 gap-4">
    <div class="bg-zinc-900 rounded-lg p-4 space-y-3">
      <label class="block text-sm">Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
      <input id="file" type="file" accept="image/*" class="w-full text-sm"/>

      <div>
        <label class="text-sm">Ø­Ø¬Ù… Ø§Ù„Ø®Ù„ÙŠØ© (px)</label>
        <input id="cellSize" type="number" value="8" min="4" max="40" class="w-full p-1 text-black rounded"/>
      </div>

      <div>
        <label class="text-sm">Ø¹ØªØ¨Ø© Ø§Ù„Ø£Ø¨ÙŠØ¶/Ø£Ø³ÙˆØ¯ (0-255)</label>
        <input id="threshold" type="range" value="128" min="0" max="255" class="w-full"/>
      </div>

      <div>
        <label class="text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù†</label>
        <input id="colors" type="number" value="3" min="1" max="10" class="w-full p-1 text-black rounded"/>
      </div>

      <button id="process" class="w-full bg-indigo-600 py-2 rounded text-white">ğŸ”§ ØªÙˆÙ„ÙŠØ¯</button>

      <div class="space-y-2">
        <button id="downloadDst" class="hidden w-full bg-green-600 py-2 rounded">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ DST</button>
      </div>
    </div>

    <div class="md:col-span-2 bg-zinc-800 rounded-lg p-4">
      <h2 class="text-sm mb-2">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</h2>
      <canvas id="preview"></canvas>
      <pre id="log" class="mono text-xs bg-black text-green-400 mt-3 p-2 h-40 overflow-auto"></pre>
    </div>
  </div>
</main>

<script>
function log(msg){
  const el=document.getElementById("log");
  el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  el.scrollTop=el.scrollHeight;
}

// --- ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù DST Ø¨ØµÙŠØºØ© Binary Ù…Ø¹ Color Changes ---
function generateDST(stitches,numColors,label="MOLFA"){
  if(stitches.length<2) return null;

  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ (mm ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: ÙƒÙ„ 1px = 0.1mm)
  let xs=stitches.map(p=>p[0]), ys=stitches.map(p=>p[1]);
  let minX=Math.min(...xs), maxX=Math.max(...xs);
  let minY=Math.min(...ys), maxY=Math.max(...ys);

  const header = new Uint8Array(512).fill(0x20);
  function put(str,off){ for(let i=0;i<str.length;i++){ if(off+i<512) header[off+i]=str.charCodeAt(i);} }

  put("LA:"+label,0);
  put("ST:"+stitches.length,20);
  put("CO:"+numColors,40);
  put("+X:"+Math.round(maxX*0.1), 70);
  put("-X:"+Math.round(minX*0.1), 100);
  put("+Y:"+Math.round(maxY*0.1), 130);
  put("-Y:"+Math.round(minY*0.1), 160);

  let body=[];
  let prevx=0, prevy=0;
  const stitchesPerColor = Math.floor(stitches.length / numColors);

  let counter=0, colorIndex=1;

  for(const [x,y] of stitches){
    let dx=Math.round(x-prevx);
    let dy=Math.round(y-prevy);
    prevx=x; prevy=y;

    let b1=0,b2=0,b3=0;
    // X+
    if(dx>0){ if(dx&1)b1|=0x01; if(dx&2)b1|=0x02; if(dx&4)b1|=0x04; if(dx&8)b2|=0x80; if(dx&16)b3|=0x20; if(dx&32)b3|=0x08; if(dx&64)b3|=0x02;}
    // X-
    if(dx<0){ let d=-dx; if(d&1)b1|=0x20; if(d&2)b1|=0x40; if(d&4)b1|=0x80; if(d&8)b2|=0x08; if(d&16)b2|=0x10; if(d&32)b2|=0x20; if(d&64)b2|=0x40;}
    // Y+
    if(dy>0){ if(dy&1)b1|=0x08; if(dy&2)b1|=0x10; if(dy&4)b2|=0x01; if(dy&8)b2|=0x02; if(dy&16)b2|=0x04; if(dy&32)b3|=0x40; if(dy&64)b3|=0x80;}
    // Y-
    if(dy<0){ let d=-dy; if(d&1)b1|=0x04; if(d&2)b1|=0x08; if(d&4)b1|=0x10; if(d&8)b2|=0x01; if(d&16)b2|=0x02; if(d&32)b2|=0x04; if(d&64)b3|=0x10;}
    body.push(b1,b2,b3);

    counter++;
    if(counter>=stitchesPerColor && colorIndex<numColors){
      body.push(0x00,0x00,0xC3); // Color Change
      colorIndex++;
      counter=0;
    }
  }

  // End code
  body.push(0x00,0x00,0xF3);

  return new Blob([header,new Uint8Array(body)],{type:"application/octet-stream"});
}

// --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© ---
document.getElementById("process").onclick=()=>{
  const f=document.getElementById("file").files[0];
  if(!f){alert("Ø§Ø®ØªØ± ØµÙˆØ±Ø©");return;}
  const cellSize=+document.getElementById("cellSize").value;
  const threshold=+document.getElementById("threshold").value;
  const numColors=+document.getElementById("colors").value;

  const img=new Image();
  img.onload=()=>{
    const canvas=document.createElement("canvas");
    const ctx=canvas.getContext("2d");
    canvas.width=img.width; canvas.height=img.height;
    ctx.drawImage(img,0,0);
    const data=ctx.getImageData(0,0,img.width,img.height).data;

    const stitches=[];
    const prev=document.getElementById("preview");
    prev.width=img.width; prev.height=img.height;
    const pctx=prev.getContext("2d");
    pctx.fillStyle="#fff"; pctx.fillRect(0,0,img.width,img.height);

    for(let y=0;y<img.height;y+=cellSize){
      for(let x=0;x<img.width;x+=cellSize){
        let sum=0,count=0;
        for(let yy=0;yy<cellSize;yy++){
          for(let xx=0;xx<cellSize;xx++){
            const i=((y+yy)*img.width+(x+xx))*4;
            sum += 0.3*data[i]+0.59*data[i+1]+0.11*data[i+2];
            count++;
          }
        }
        const lum=sum/count;
        if(lum<threshold){
          stitches.push([x,y],[x+cellSize,y+cellSize],[x+cellSize,y],[x,y+cellSize]);
        }
      }
    }

    // Ø±Ø³Ù… Ø¨Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø£Ù„ÙˆØ§Ù† Ù…ØªØ¹Ø¯Ø¯Ø©
    const colors=["red","blue","green","purple","orange","teal","brown","pink","gray","black"];
    const stitchesPerColor = Math.floor(stitches.length / numColors);
    let colorIndex=0, counter=0;
    for(let i=0;i<stitches.length;i+=2){
      if(counter>=stitchesPerColor && colorIndex<numColors-1){
        colorIndex++;
        counter=0;
      }
      pctx.strokeStyle=colors[colorIndex%colors.length];
      pctx.beginPath();
      pctx.moveTo(stitches[i][0],stitches[i][1]);
      pctx.lineTo(stitches[i+1][0],stitches[i+1][1]);
      pctx.stroke();
      counter++;
    }

    const dst=generateDST(stitches,numColors);
    document.getElementById("downloadDst").onclick=()=>download(dst,"molfa_colors.dst");
    document.getElementById("downloadDst").classList.remove("hidden");

    log(`ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ â€” Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ø²: ${stitches.length}, Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù†: ${numColors}`);
  };
  img.src=URL.createObjectURL(f);
};

function download(blob,name){
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=name; a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
