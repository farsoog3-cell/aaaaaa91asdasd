<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<title>تحويل الصور إلى تطريز</title>
<style>
  body { font-family: sans-serif; text-align:center; background:#f9f9f9; }
  canvas { border:1px solid #ccc; margin-top:10px; }
</style>
</head>
<body>
  <h2>تحويل أي صورة إلى مخطط تطريز (حواف)</h2>
  <input type="file" id="upload" accept="image/*"/><br/>
  <button id="exportDST">تصدير DST</button>
  <button id="exportDSE">تصدير DSE</button><br/>
  <canvas id="preview"></canvas>

<script>
// دالة كشف الحواف (Sobel مبسط)
function detectEdges(ctx, w, h, threshold=40) {
  const id = ctx.getImageData(0,0,w,h);
  const d = id.data;
  const edges = [];
  for (let y=1; y<h-1; y++) {
    for (let x=1; x<w-1; x++) {
      const i=(y*w+x)*4;
      const gx = (
        -d[((y-1)*w+x-1)*4] -2*d[(y*w+x-1)*4] -d[((y+1)*w+x-1)*4] +
        d[((y-1)*w+x+1)*4] +2*d[((y*w+x+1)*4] +d[((y+1)*w+x+1)*4]
      );
      const gy = (
        -d[((y-1)*w+x-1)*4] -2*d[((y-1)*w+x)*4] -d[((y-1)*w+x+1)*4] +
        d[((y+1)*w+x-1)*4] +2*d[((y+1)*w+x)*4] +d[((y+1)*w+x+1)*4]
      );
      const g = Math.sqrt(gx*gx+gy*gy);
      if (g > threshold) edges.push([x,y]);
    }
  }
  return edges;
}

let stitchPoints=[];

document.getElementById("upload").addEventListener("change",e=>{
  const file = e.target.files[0];
  const img = new Image();
  img.onload = ()=>{
    const canvas=document.getElementById("preview");
    const ctx=canvas.getContext("2d");
    const w=300, h=300; // حجم ثابت للمعاينة
    canvas.width=w; canvas.height=h;
    ctx.drawImage(img,0,0,w,h);

    // كشف الحواف
    stitchPoints = detectEdges(ctx,w,h,50);

    // عرض الحواف
    ctx.drawImage(img,0,0,w,h);
    ctx.strokeStyle="black"; ctx.beginPath();
    stitchPoints.forEach(([x,y],i)=>{
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }
  img.src=URL.createObjectURL(file);
});

// توليد ملف DST مبسط
function exportDST(points) {
  let content="DST-STITCH\n";
  points.forEach(([x,y])=>{
    content+=`STITCH ${x},${y}\n`;
  });
  return content;
}

document.getElementById("exportDST").onclick=()=>{
  const blob=new Blob([exportDST(stitchPoints)],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="design.dst";
  a.click();
};

document.getElementById("exportDSE").onclick=()=>{
  const blob=new Blob([exportDST(stitchPoints)],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="design.dse";
  a.click();
};
</script>
</body>
</html>
