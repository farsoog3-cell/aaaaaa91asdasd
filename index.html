<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Molfa â€” Ù…Ù„ÙØ§Øª ØªØ·Ø±ÙŠØ² Ø¬Ø§Ù‡Ø²Ø©</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{font-family:Inter,system-ui,Arial;background:#000;color:#fff;}
.mono{font-family:ui-monospace,monospace;}
.svg-wrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
.svg-wrap svg,.svg-wrap object{width:100%;height:100%;}
input,button{color:#000;}
header p{font-size:0.9rem;opacity:0.8;}
</style>
</head>
<body class="min-h-screen flex flex-col">
<header class="bg-black text-white py-4 shadow text-center border-b border-gray-700">
<h1 class="text-xl font-semibold">Molfa â€” ØµÙˆØ±Ø© â†’ Ø®ÙŠÙˆØ· + Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ø¬Ø§Ù‡Ø²Ø©</h1>
<p>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØªØ¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© + Ø§Ù„Ø®ÙŠÙˆØ·. Ù…Ù„ÙØ§Øª DST/DTE/DSE Ù…Ø¹ ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙƒØ§Ù…Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù.</p>
</header>

<main class="container mx-auto p-4 md:p-6 flex-grow">
<div class="bg-black rounded-xl border border-gray-700 p-4 md:p-6">
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">

<!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ­ÙƒÙ… -->
<div>
<label class="block font-medium mb-2">Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
<label class="flex items-center justify-center cursor-pointer bg-white text-black px-4 py-2 rounded-lg shadow hover:bg-gray-200 transition">
ğŸ“‚ Ø±ÙØ¹ ØµÙˆØ±Ø©
<input id="file" type="file" accept="image/*" class="hidden"/>
</label>

<div class="mt-5 space-y-3">
<div>
<label class="text-sm block mb-1">Ø­Ø¬Ù… Ø§Ù„Ø®Ù„ÙŠØ© (px)</label>
<input id="cellSize" type="number" min="4" max="40" value="12" class="w-full p-2 rounded"/>
</div>
<div>
<label class="text-sm block mb-1">Ø¹ØªØ¨Ø© Ø§Ù„Ø£Ø¨ÙŠØ¶/Ø§Ù„Ø£Ø³ÙˆØ¯</label>
<input id="bwThreshold" type="range" min="0" max="255" value="128" class="w-full"/>
</div>
<div>
<label class="text-sm block mb-1">Ø·ÙˆÙ„ Ø§Ù„ØºØ±Ø²Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®Ù„ÙŠØ© (px)</label>
<input id="stitchStep" type="number" min="1" max="16" value="4" class="w-full p-2 rounded"/>
</div>
<div>
<label class="text-sm block mb-1">Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„ØªØµØ¯ÙŠØ± (px â†’ mm)</label>
<input id="exportScale" type="number" value="0.2" step="0.05" min="0.05" max="5" class="w-full p-2 rounded"/>
</div>
</div>

<div class="mt-6">
<button id="process" class="w-full bg-white text-black font-bold py-2 rounded shadow hover:bg-gray-200 transition">ğŸ”§ ØªÙˆÙ„ÙŠØ¯ ÙˆØªØµØ¯ÙŠØ±</button>
</div>

<div class="mt-4 grid grid-cols-2 gap-2">
<button id="downloadSvg" class="hidden bg-gray-800 text-white py-2 rounded">â¬‡ï¸ SVG</button>
<button id="downloadDst" class="hidden bg-gray-800 text-white py-2 rounded">â¬‡ï¸ DST</button>
<button id="downloadDte" class="hidden bg-gray-800 text-white py-2 rounded">â¬‡ï¸ DTE</button>
<button id="downloadDse" class="hidden bg-gray-800 text-white py-2 rounded">â¬‡ï¸ DSE</button>
<button id="downloadPng" class="hidden bg-gray-800 text-white py-2 rounded">â¬‡ï¸ PNG</button>
</div>

<div class="mt-6 text-sm space-y-1 text-gray-300">
<div>ğŸ“Œ Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ø²: <span id="autoStitches">0</span></div>
<div>ğŸ“Œ Ø·ÙˆÙ„ Ø§Ù„Ø®ÙŠØ· (mm): <span id="autoThread">0</span></div>
<div>ğŸ“Œ Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø±Ø²: <span id="autoBeads">0</span></div>
</div>
</div>

<!-- Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
<div class="md:col-span-2">
<div class="bg-black border border-gray-700 p-3 rounded min-h-[380px] flex items-center justify-center">
  <div id="svgPreview" class="svg-wrap text-gray-500">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø¹Ø¯</div>
</div>
<pre id="log" class="mono text-xs h-40 overflow-auto whitespace-pre-wrap bg-black border border-gray-700 p-2 rounded mt-3 text-gray-300"></pre>
</div>

</div>
</div>
</main>

<script>
function log(msg){ const el=document.getElementById('log'); el.textContent += '['+new Date().toLocaleTimeString()+'] '+msg+"\n"; el.scrollTop = el.scrollHeight; }
function forceDownload(blob,name){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),2000); }

function buildMachineFile(points, exportScale, settings){
    const header = new Uint8Array(512);
    let info = `NAME:${settings.label}\nCELL:${settings.cellSize} THRESH:${settings.threshold} STEP:${settings.stitchStep} SCALE:${settings.exportScale}\nST:${settings.stitches} TL:${Math.round(settings.threadLength)}mm BE:${settings.beads}\n`;
    info = info.slice(0,80);
    for(let i=0;i<info.length;i++) header[i]=info.charCodeAt(i);

    const body=[];
    let prevx=0, prevy=0;
    function toCoord(px){ return Math.round(px*exportScale); }
    for(const p of points){
        const x=toCoord(p[0]), y=toCoord(p[1]);
        let dx=x-prevx, dy=y-prevy;
        while(Math.abs(dx)>127 || Math.abs(dy)>127){
            const sx=Math.max(-127, Math.min(127, dx));
            const sy=Math.max(-127, Math.min(127, dy));
            body.push((sx&0xFF),(sy&0xFF),0x01);
            dx-=sx; dy-=sy; prevx+=sx; prevy+=sy;
        }
        body.push((dx&0xFF),(dy&0xFF),0x03);
        prevx=x; prevy=y;
    }
    body.push(0x00,0x00,0xF3);
    const arr = new Uint8Array(512 + body.length);
    arr.set(header,0);
    arr.set(new Uint8Array(body),512);
    return arr;
}

const fileInput=document.getElementById('file');
const btn=document.getElementById('process');
const preview=document.getElementById('svgPreview');
const dlSvg=document.getElementById('downloadSvg');
const dlDst=document.getElementById('downloadDst');
const dlDte=document.getElementById('downloadDte');
const dlDse=document.getElementById('downloadDse');
const dlPng=document.getElementById('downloadPng');
const stitchesEl=document.getElementById('autoStitches');
const threadEl=document.getElementById('autoThread');
const beadsEl=document.getElementById('autoBeads');

let lastSvg,lastDst,lastDte,lastDse,lastPng;

btn.addEventListener('click',()=>{
    const f=fileInput.files[0];
    if(!f){ alert('Ø§Ø®ØªØ± ØµÙˆØ±Ø©'); return; }
    const reader=new FileReader();
    reader.onload=()=>{
        const img=new Image();
        img.onload=()=>{
            const cell=+document.getElementById('cellSize').value;
            const bwThreshold=+document.getElementById('bwThreshold').value;
            const stitchStep=+document.getElementById('stitchStep').value;
            const exportScale=+document.getElementById('exportScale').value;

            const canvas=document.createElement('canvas');
            canvas.width=img.width; canvas.height=img.height;
            const ctx=canvas.getContext('2d');
            ctx.drawImage(img,0,0);

            const id=ctx.getImageData(0,0,img.width,img.height);
            const d=id.data;
            const stitchPoints=[];
            let blackCells=0;

            for(let y=0;y<img.height;y+=cell){
                for(let x=0;x<img.width;x+=cell){
                    let sum=0,count=0;
                    for(let yy=y; yy<y+cell && yy<img.height; yy++){
                        for(let xx=x; xx<x+cell && xx<img.width; xx++){
                            const i=(yy*img.width+xx)*4;
                            sum+=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
                            count++;
                        }
                    }
                    const lum=sum/count;
                    if(lum<bwThreshold){
                        stitchPoints.push([x,y]);
                        stitchPoints.push([x+cell,y+cell]);
                        stitchPoints.push([x+cell,y]);
                        stitchPoints.push([x,y+cell]);
                        blackCells++;
                    }
                }
            }

            const totalLength=stitchPoints.reduce((acc,p,i,arr)=>{
                if(i==0) return acc;
                const dx=p[0]-arr[i-1][0], dy=p[1]-arr[i-1][1];
                return acc+Math.hypot(dx,dy);
            },0);

            const settings={
                label:"MOLFA",
                cellSize:cell,
                threshold:bwThreshold,
                stitchStep:stitchStep,
                exportScale:exportScale,
                stitches:stitchPoints.length,
                threadLength:totalLength,
                beads:blackCells
            };

            stitchesEl.textContent=settings.stitches;
            threadEl.textContent=Math.round(settings.threadLength*exportScale);
            beadsEl.textContent=settings.beads;

            log(`ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ âœ… ØºØ±Ø²:${settings.stitches} Ø·ÙˆÙ„ Ø§Ù„Ø®ÙŠØ·(mm):${Math.round(settings.threadLength*exportScale)} Ø®Ø±Ø²:${settings.beads}`);

            lastDst=new Blob([buildMachineFile(stitchPoints,exportScale,settings)],{type:'application/octet-stream'});
            lastDte=new Blob([buildMachineFile(stitchPoints,exportScale,settings)],{type:'application/octet-stream'});
            lastDse=new Blob([buildMachineFile(stitchPoints,exportScale,settings)],{type:'application/octet-stream'});

            let svg=`<svg xmlns='http://www.w3.org/2000/svg' width='${img.width}' height='${img.height}' viewBox='0 0 ${img.width} ${img.height}'>`;
            svg+=`<image href='${reader.result}' width='${img.width}' height='${img.height}' opacity='0.5'/>`;
            svg+=`<g stroke='red' stroke-width='1'>`;
            for(let i=0;i<stitchPoints.length;i+=2){
                if(stitchPoints[i+1]) svg+=`<line x1='${stitchPoints[i][0]}' y1='${stitchPoints[i][1]}' x2='${stitchPoints[i+1][0]}' y2='${stitchPoints[i+1][1]}'/>`;
            }
            svg+=`</g></svg>`;
            lastSvg=new Blob([svg],{type:'image/svg+xml'});

            const pngCanvas=document.createElement('canvas');
            pngCanvas.width=img.width; pngCanvas.height=img.height;
            const pngCtx=pngCanvas.getContext('2d');
            pngCtx.drawImage(img,0,0);
            pngCtx.strokeStyle='red'; pngCtx.lineWidth=1;
            for(let i=0;i<stitchPoints.length;i+=2){
                if(stitchPoints[i+1]){
                    pngCtx.beginPath();
                    pngCtx.moveTo(stitchPoints[i][0],stitchPoints[i][1]);
                    pngCtx.lineTo(stitchPoints[i+1][0],stitchPoints[i+1][1]);
                    pngCtx.stroke();
                }
            }
            pngCanvas.toBlob(blob=>{ lastPng=blob; },'image/png');

            preview.innerHTML=`<object type="image/svg+xml" data="${URL.createObjectURL(lastSvg)}" style="width:100%;height:100%"></object>`;
            dlSvg.classList.remove('hidden');
            dlDst.classList.remove('hidden');
            dlDte.classList.remove('hidden');
            dlDse.classList.remove('hidden');
            dlPng.classList.remove('hidden');

            dlSvg.onclick=()=>forceDownload(lastSvg,'molfa.svg');
            dlDst.onclick=()=>forceDownload(lastDst,'molfa.dst');
            dlDte.onclick=()=>forceDownload(lastDte,'molfa.dte');
            dlDse.onclick=()=>forceDownload(lastDse,'molfa.dse');
            dlPng.onclick=()=>forceDownload(lastPng,'molfa.png');
        };
        img.src=reader.result;
    };
    reader.readAsDataURL(f);
});
</script>
</body>
</html>
