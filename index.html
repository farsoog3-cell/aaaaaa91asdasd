<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Molfa â€” ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØªØ·Ø±ÙŠØ²</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:Inter,system-ui,Arial;}
    #log{font-family:ui-monospace,monospace;}
  </style>
</head>
<body class="h-screen w-screen flex flex-col bg-black text-white">
  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <header class="p-4 border-b border-gray-800 flex items-center justify-between">
    <h1 class="text-xl font-bold">ğŸ§µ Molfa</h1>
    <span class="text-sm opacity-70">ØµÙˆØ±Ø© â†’ Ù…Ù„Ù ØªØ·Ø±ÙŠØ² DST</span>
  </header>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
  <main class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4 p-4 overflow-hidden">
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <section class="bg-white text-black rounded-xl shadow p-4 flex flex-col gap-3 overflow-auto">
      <h2 class="font-semibold text-lg mb-2">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>

      <div>
        <label class="block mb-1 text-sm">Ø§Ø®ØªØ± ØµÙˆØ±Ø©:</label>
        <input id="file" type="file" accept="image/*" class="w-full border rounded p-2"/>
      </div>

      <div>
        <label class="block mb-1 text-sm">Ø­Ø¬Ù… Ø§Ù„Ø®Ù„ÙŠØ© (px)</label>
        <input id="cellSize" type="number" value="8" min="4" max="40" class="w-full border rounded p-2"/>
      </div>

      <div>
        <label class="block mb-1 text-sm">Ø¹ØªØ¨Ø© Ø§Ù„Ø£Ø¨ÙŠØ¶/Ø£Ø³ÙˆØ¯</label>
        <input id="threshold" type="number" value="128" min="0" max="255" class="w-full border rounded p-2"/>
      </div>

      <div>
        <label class="block mb-1 text-sm">Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ (px â†’ mm)</label>
        <input id="scale" type="number" value="0.2" step="0.05" class="w-full border rounded p-2"/>
      </div>

      <button id="process" class="bg-indigo-600 text-white w-full py-2 rounded hover:bg-indigo-700 transition">
        ğŸ”§ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª
      </button>

      <div id="downloads" class="hidden space-y-2 mt-3">
        <button id="downloadDst" class="bg-green-600 text-white w-full py-2 rounded">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ DST</button>
        <button id="downloadPng" class="bg-gray-600 text-white w-full py-2 rounded">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ PNG</button>
      </div>
    </section>

    <!-- Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© + Ø§Ù„Ù„ÙˆØ¬ -->
    <section class="md:col-span-2 flex flex-col gap-4 overflow-hidden">
      
      <!-- Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
      <div class="bg-white text-black rounded-xl shadow flex-1 flex items-center justify-center overflow-auto p-2">
        <canvas id="stitchCanvas" class="max-w-full max-h-full"></canvas>
      </div>

      <!-- Ø§Ù„Ù„ÙˆØ¬ -->
      <div class="bg-gray-900 text-green-400 rounded-xl shadow p-3 h-32 overflow-auto text-xs font-mono">
        <pre id="log">[Ø¬Ø§Ù‡Ø²] Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØ§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯...</pre>
      </div>
    </section>
  </main>

<script>
function log(msg){
  const el=document.getElementById('log');
  el.textContent += "\\n["+new Date().toLocaleTimeString()+"] "+msg;
  el.scrollTop = el.scrollHeight;
}

function forceDownload(blob,name){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=name; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),2000);
}

// Worker code
function makeWorker(fn){
  const blob=new Blob(['('+fn.toString()+')()'],{type:'application/javascript'});
  return new Worker(URL.createObjectURL(blob));
}

const worker = makeWorker(function(){
  function buildDst(points, scale){
    const header = new Uint8Array(512);
    const name = "LA:Molfa\\n";
    for(let i=0;i<name.length;i++) header[i] = name.charCodeAt(i);
    const body=[];
    let prevx=0, prevy=0;
    function toCoord(px){ return Math.round(px*scale); }
    for(const p of points){
      const x=toCoord(p[0]), y=toCoord(p[1]);
      let dx=x-prevx, dy=y-prevy;
      while(Math.abs(dx)>121||Math.abs(dy)>121){
        const sx=Math.max(-121,Math.min(121,dx));
        const sy=Math.max(-121,Math.min(121,dy));
        body.push((sx&0xFF),(sy&0xFF),0x83);
        dx-=sx; dy-=sy; prevx+=sx; prevy+=sy;
      }
      body.push((dx&0xFF),(dy&0xFF),0x03);
      prevx=x; prevy=y;
    }
    body.push(0x00,0x00,0xF3);
    const arr=new Uint8Array(512+body.length);
    arr.set(header,0); arr.set(new Uint8Array(body),512);
    return arr;
  }

  onmessage=async(ev)=>{
    try{
      const {dataURL,cellSize,threshold,scale}=ev.data;
      const imgBlob=await (await fetch(dataURL)).blob();
      const img=await createImageBitmap(imgBlob);
      const cell=cellSize;
      const w=Math.floor(img.width/cell)*cell;
      const h=Math.floor(img.height/cell)*cell;
      const off=new OffscreenCanvas(w,h);
      const ctx=off.getContext('2d');
      ctx.drawImage(img,0,0,w,h);
      const id=ctx.getImageData(0,0,w,h);
      const d=id.data;
      const pts=[];
      for(let gy=0;gy<h;gy+=cell){
        for(let gx=0;gx<w;gx+=cell){
          let sr=0,sg=0,sb=0,c=0;
          for(let yy=0;yy<cell;yy++){
            for(let xx=0;xx<cell;xx++){
              const i=((gy+yy)*w+(gx+xx))*4;
              sr+=d[i]; sg+=d[i+1]; sb+=d[i+2]; c++;
            }
          }
          const lum=(0.299*(sr/c)+0.587*(sg/c)+0.114*(sb/c));
          if(lum<threshold){
            pts.push([gx,gy],[gx+cell,gy+cell]);
            pts.push([gx+cell,gy],[gx,gy+cell]);
          }
        }
      }
      const dst=buildDst(pts,scale);
      postMessage({dst:dst.buffer,points:pts,w,h},{transfer:[dst.buffer]});
    }catch(err){
      postMessage({error:err.message});
    }
  }
});

const fileInput=document.getElementById('file');
const btn=document.getElementById('process');
const canvas=document.getElementById('stitchCanvas');
const ctx=canvas.getContext('2d');
const dl=document.getElementById('downloads');
const dlDst=document.getElementById('downloadDst');
const dlPng=document.getElementById('downloadPng');
let lastDst,lastPng;

worker.onmessage=(ev)=>{
  if(ev.data.error){ log("Ø®Ø·Ø£: "+ev.data.error); return; }
  log("ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©ØŒ Ø§Ù„ØºØ±Ø²: "+ev.data.points.length);
  lastDst=new Blob([ev.data.dst],{type:'application/octet-stream'});
  // Ø±Ø³Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
  canvas.width=ev.data.w; canvas.height=ev.data.h;
  ctx.fillStyle="white"; ctx.fillRect(0,0,ev.data.w,ev.data.h);
  ctx.strokeStyle="black"; ctx.lineWidth=1;
  for(let i=0;i<ev.data.points.length;i+=2){
    ctx.beginPath();
    ctx.moveTo(ev.data.points[i][0],ev.data.points[i][1]);
    ctx.lineTo(ev.data.points[i+1][0],ev.data.points[i+1][1]);
    ctx.stroke();
  }
  canvas.toBlob(b=>{ lastPng=b; },'image/png');
  dl.classList.remove('hidden');
};

btn.onclick=()=>{
  const f=fileInput.files[0];
  if(!f){ alert("Ø§Ø®ØªØ± ØµÙˆØ±Ø©"); return; }
  const reader=new FileReader();
  reader.onload=()=>{
    worker.postMessage({
      dataURL:reader.result,
      cellSize:Number(document.getElementById('cellSize').value),
      threshold:Number(document.getElementById('threshold').value),
      scale:Number(document.getElementById('scale').value)
    });
    log("Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...");
  };
  reader.readAsDataURL(f);
};

dlDst.onclick=()=>forceDownload(lastDst,"molfa.dst");
dlPng.onclick=()=>forceDownload(lastPng,"molfa.png");
</script>
</body>
</html>
