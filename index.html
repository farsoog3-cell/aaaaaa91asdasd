<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Molfa — مخطط غرز كامل</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{font-family:Inter,system-ui,Arial;background:#111;color:#fff;}
.mono{font-family:ui-monospace,monospace;}
input,button{color:#000;}
header p{font-size:0.9rem;opacity:0.8;}
button:hover{cursor:pointer;}
canvas{border:1px solid #555; background:#000;}
::-webkit-scrollbar {width:6px;}
::-webkit-scrollbar-thumb {background:#555; border-radius:3px;}
</style>
</head>
<body class="min-h-screen flex flex-col">

<header class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 text-white py-5 shadow-lg text-center">
<h1 class="text-2xl md:text-3xl font-bold">Molfa — تحويل الصورة إلى مخطط غرز دقيق</h1>
<p class="mt-1 text-gray-300 text-sm md:text-base">كل غرزة محسوبة: اتجاه الإبرة، طول الغرز، تعليمات القفز، كثافة الخيط.</p>
</header>

<main class="flex-grow container mx-auto p-4 md:p-6">
<div class="grid md:grid-cols-3 gap-6">

<div class="bg-gray-900 p-5 rounded-xl shadow-lg border border-gray-700">
<h2 class="text-lg font-semibold mb-4">إعدادات التحويل</h2>
<label class="block mb-3">
<span class="font-medium">اختر صورة</span>
<label class="flex items-center justify-center mt-1 bg-white text-black px-4 py-2 rounded-lg shadow hover:bg-gray-200 transition">
📂 رفع صورة
<input id="file" type="file" accept="image/*" class="hidden"/>
</label>
</label>

<div class="space-y-4">
<div>
<label class="block text-sm font-medium mb-1">حجم الخلية (px)</label>
<input id="cellSize" type="number" min="1" max="4" value="2" class="w-full p-2 rounded"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">عتبة الأبيض/الأسود</label>
<input id="bwThreshold" type="range" min="0" max="255" value="128" class="w-full"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">مقياس التصدير (px → mm)</label>
<input id="exportScale" type="number" value="0.2" step="0.05" min="0.05" max="5" class="w-full p-2 rounded"/>
</div>
</div>

<div class="mt-5">
<button id="process" class="w-full bg-green-500 text-white font-bold py-2 rounded shadow hover:bg-green-600 transition">🔧 توليد وتصدير</button>
</div>

<div class="mt-4 grid grid-cols-2 gap-2">
<button id="downloadDse" class="hidden bg-blue-700 text-white py-2 rounded hover:bg-blue-800 transition">⬇️ DSE</button>
<button id="downloadPng" class="hidden bg-gray-700 text-white py-2 rounded hover:bg-gray-800 transition">⬇️ PNG</button>
</div>

<div class="mt-5 text-sm text-gray-300 space-y-1">
<div>📌 عدد الغرز: <span id="autoStitches">0</span></div>
<div>📌 طول الخيط (mm): <span id="autoThread">0</span></div>
<div>📌 عدد الخلايا السوداء: <span id="autoBlackCells">0</span></div>
</div>

<pre id="log" class="mono text-xs h-40 overflow-auto whitespace-pre-wrap bg-gray-900 border border-gray-700 p-2 rounded mt-3 text-gray-300"></pre>
</div>

<div class="md:col-span-2 flex flex-col items-center">
<div class="bg-gray-900 p-3 rounded shadow-lg w-full flex justify-center items-center">
<canvas id="previewCanvas" width="400" height="400" style="max-width:100%;"></canvas>
</div>
</div>

</div>
</main>

<script>
function log(msg){ const el=document.getElementById('log'); el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`; el.scrollTop = el.scrollHeight; }
function forceDownload(blob,name){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),2000); }

// توليد ملف DSE متوافق مع برامج التطريز
function buildDSE(points, scale, settings){
    const header=new Uint8Array(512);
    let info=`NAME:${settings.label}\nCELL:${settings.cellSize} THRESH:${settings.threshold} SCALE:${scale}\nST:${settings.stitches} TL:${Math.round(settings.threadLength)}mm BC:${settings.blackCells}\n`;
    info=info.slice(0,80);
    for(let i=0;i<info.length;i++) header[i]=info.charCodeAt(i);

    const body=[];
    let prevx=0, prevy=0;
    function toCoord(px){ return Math.round(px*scale); }

    for(const p of points){
        const x=toCoord(p[0]), y=toCoord(p[1]);
        let dx=x-prevx, dy=y-prevy;

        while(Math.abs(dx)>127 || Math.abs(dy)>127){
            const sx=Math.max(-127, Math.min(127, dx));
            const sy=Math.max(-127, Math.min(127, dy));
            body.push(sx&0xFF,sy&0xFF,0x01);
            dx-=sx; dy-=sy; prevx+=sx; prevy+=sy;
        }
        body.push(dx&0xFF, dy&0xFF, 0x03);
        prevx=x; prevy=y;
    }

    body.push(0x00,0x00,0xF3);
    const arr=new Uint8Array(512+body.length);
    arr.set(header,0);
    arr.set(new Uint8Array(body),512);
    return arr;
}

// تحويل الصورة إلى غرز Raster Scan دقيقة
function rasterStitches(image, cell, threshold){
    const canvas=document.createElement('canvas');
    canvas.width=image.width; canvas.height=image.height;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(image,0,0);
    const data=ctx.getImageData(0,0,image.width,image.height).data;

    const points=[];
    let blackCells=0;

    for(let y=0;y<image.height;y+=cell){
        for(let x=0;x<image.width;x+=cell){
            let sum=0,count=0;
            for(let yy=y;yy<y+cell && yy<image.height;yy++){
                for(let xx=x;xx<x+cell && xx<image.width;xx++){
                    const i=(yy*image.width+xx)*4;
                    sum+=0.299*data[i]+0.587*data[i+1]+0.114*data[i+2];
                    count++;
                }
            }
            const lum=sum/count;
            if(lum<threshold){
                blackCells++;
                points.push([x+cell/2, y+cell/2]);
            }
        }
    }
    return {points,blackCells};
}

const fileInput=document.getElementById('file');
const btn=document.getElementById('process');
const canvas=document.getElementById('previewCanvas');
const ctx=canvas.getContext('2d');
const dlDse=document.getElementById('downloadDse');
const dlPng=document.getElementById('downloadPng');
const stitchesEl=document.getElementById('autoStitches');
const threadEl=document.getElementById('autoThread');
const blackCellsEl=document.getElementById('autoBlackCells');

let lastDse;

btn.addEventListener('click',()=>{
    const f=fileInput.files[0];
    if(!f){ alert('اختر صورة'); return; }
    const reader=new FileReader();
    reader.onload=()=>{
        const img=new Image();
        img.onload=()=>{
            canvas.width=img.width; canvas.height=img.height;
            ctx.clearRect(0,0,img.width,img.height);
            ctx.drawImage(img,0,0);

            const cell=+document.getElementById('cellSize').value;
            const threshold=+document.getElementById('bwThreshold').value;
            const scale=+document.getElementById('exportScale').value;

            const {points,blackCells}=rasterStitches(img,cell,threshold);

            // رسم المخطط على الكانفاس
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.strokeStyle='lime'; ctx.lineWidth=1;
            for(let i=1;i<points.length;i++){
                ctx.beginPath();
                ctx.moveTo(points[i-1][0],points[i-1][1]);
                ctx.lineTo(points[i][0],points[i][1]);
                ctx.stroke();
            }

            let totalLength=0;
            for(let i=1;i<points.length;i++){
                totalLength+=Math.hypot(points[i][0]-points[i-1][0], points[i][1]-points[i-1][1]);
            }

            const settings={label:"MOLFA",cellSize:cell,threshold:threshold,stitches:points.length,threadLength:totalLength,blackCells:blackCells};

            stitchesEl.textContent=settings.stitches;
            threadEl.textContent=Math.round(totalLength*scale);
            blackCellsEl.textContent=settings.blackCells;

            log(`✅ تم التوليد — غرز:${settings.stitches} طول الخيط(mm):${Math.round(totalLength*scale)} خلايا سوداء:${settings.blackCells}`);

            lastDse=new Blob([buildDSE(points,scale,settings)],{type:'application/octet-stream'});
            dlDse.classList.remove('hidden');
            dlPng.classList.remove('hidden');

            dlDse.onclick=()=>forceDownload(lastDse,'molfa_stitch.dse');
            dlPng.onclick=()=>canvas.toBlob(b=>forceDownload(b,'molfa_stitch.png'),'image/png');
        };
        img.src=reader.result;
    };
    reader.readAsDataURL(f);
});
</script>
</body>
</html>
